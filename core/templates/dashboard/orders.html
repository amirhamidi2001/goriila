{% extends 'base.html' %}
{% load dashboard_tags %}
{% load static %}
{% load humanize %}

{% block title %}
  سفارش‌های من | فروشگاه اینترنتی مکمل گوریلا
{% endblock %}

{% block content %}
  <main class="main">
    <!-- Page Title -->
    <div class="page-title light-background">
      <div class="container d-lg-flex justify-content-between align-items-center">
        <h1 class="mb-2 mb-lg-0">سفارش‌های من</h1>
        <nav class="breadcrumbs">
          <ol>
            <li>
              <a href="{% url 'website:index' %}">صفحه اصلی</a>
            </li>
            <li class="current">سفارش‌های من</li>
          </ol>
        </nav>
      </div>
    </div>

    <!-- Account Section -->
    <section id="account" class="account section">
      <div class="container" data-aos="fade-up" data-aos-delay="100">
        <!-- Mobile Menu Toggle -->
        <div class="mobile-menu d-lg-none mb-4">
          <button class="mobile-menu-toggle" type="button" data-bs-toggle="collapse" data-bs-target="#profileMenu">
            <i class="bi bi-grid"></i>
            <span>منو</span>
          </button>
        </div>

        <div class="row g-4">
          <!-- Profile Menu -->
          <div class="col-lg-3">
            <div class="profile-menu collapse d-lg-block" id="profileMenu">
              <!-- User Info -->
              <div class="user-info" data-aos="fade-right">
                <div class="user-avatar">
                  <img src="{{ profile.image.url }}" alt="Profile" loading="lazy" />
                  <span class="status-badge"><i class="bi bi-shield-check"></i></span>
                </div>
                <h4>{{ profile.get_fullname }}</h4>
                <div class="user-status">
                  <i class="bi bi-calendar"></i>
                  <span>{{ profile.created_date|date:'j F Y' }}</span>
                </div>
              </div>

              <!-- Navigation Menu -->
              <nav class="menu-nav">
                <ul class="nav flex-column" role="tablist">
                  <li class="nav-item">
                    <a class="nav-link active" href="{% url 'dashboard:orders' %}">
                      <i class="bi bi-box-seam"></i>&nbsp;
                      <span>سفارش ها</span>
                      <span class="badge">{{ order_stats.all }}</span>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="">
                      <i class="bi bi-heart"></i>&nbsp;
                      <span>علاقه مندی ها</span>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="{% url 'dashboard:wallet' %}">
                      <i class="bi bi-wallet2"></i>&nbsp;
                      <span>پرداخت ها</span>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="{% url 'dashboard:addresses' %}">
                      <i class="bi bi-geo-alt"></i>&nbsp;
                      <span>آدرس ها</span>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="">
                      <i class="bi bi-gear"></i>&nbsp;
                      <span>تنظیمات حساب</span>
                    </a>
                  </li>
                </ul>

                <div class="menu-footer">
                  <a href="{% url 'website:faq' %}" class="help-link">
                    <i class="bi bi-question-circle"></i>&nbsp;
                    <span>راهنمایی</span>
                  </a>
                  <a href="{% url 'accounts:logout' %}" class="logout-link">
                    <i class="bi bi-box-arrow-right"></i>&nbsp;
                    <span>خروج</span>
                  </a>
                </div>
              </nav>
            </div>
          </div>

          <!-- Content Area -->
          <div class="col-lg-9">
            <div class="content-area">
              <!-- Orders Header -->
              <div class="section-header" data-aos="fade-up">
                <h2>سفارش‌های من</h2>
                <div class="header-actions">
                  <!-- Search Box -->
                  <div class="search-box">
                    <form method="get" action="">
                      <i class="bi bi-search"></i>
                      <input type="text" name="search" value="{{ search_query }}" placeholder="جستجوی سفارش‌ها ..." />
                    </form>
                  </div>

                  <!-- Filter Dropdown -->
                  <div class="dropdown">
                    <button class="filter-btn" data-bs-toggle="dropdown">
                      <i class="bi bi-funnel"></i>
                      <span>فیلتر</span>
                    </button>
                    <ul class="dropdown-menu">
                      <li>
                        <a class="dropdown-item {% if current_status == 'all' %}active{% endif %}" href="?status=all">همه سفارشات ({{ order_stats.all }})</a>
                      </li>
                      <li>
                        <a class="dropdown-item {% if current_status == 'pending' %}active{% endif %}" href="?status=pending">در انتظار بررسی ({{ order_stats.pending }})</a>
                      </li>
                      <li>
                        <a class="dropdown-item {% if current_status == 'processing' %}active{% endif %}" href="?status=processing">در حال پردازش ({{ order_stats.processing }})</a>
                      </li>
                      <li>
                        <a class="dropdown-item {% if current_status == 'shipped' %}active{% endif %}" href="?status=shipped">ارسال شده ({{ order_stats.shipped }})</a>
                      </li>
                      <li>
                        <a class="dropdown-item {% if current_status == 'delivered' %}active{% endif %}" href="?status=delivered">تحویل داده شده ({{ order_stats.delivered }})</a>
                      </li>
                      <li>
                        <a class="dropdown-item {% if current_status == 'cancelled' %}active{% endif %}" href="?status=cancelled">لغو شده ({{ order_stats.cancelled }})</a>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>

              {% if orders %}
                <div class="orders-grid">
                  {% for order in orders %}
                    <!-- Order Card -->
                    <div class="order-card" data-aos="fade-up" data-aos-delay="{{ forloop.counter|add:0|mul:100 }}">
                      <div class="order-header">
                        <div class="order-id">
                          <span class="label">شناسه سفارش:</span>
                          <span class="value">#{{ order.order_number }}</span>
                        </div>
                        <div class="order-date">{{ order.created_date|date:'j F Y' }}</div>
                      </div>

                      <div class="order-content">
                        <!-- Product Images -->
                        <div class="product-grid">
                          {% for item in order.items.all|slice:':3' %}
                            {% if item.product.image %}
                              <img src="{{ item.product.image.url }}" alt="{{ item.product_name }}" loading="lazy" />
                            {% endif %}
                          {% endfor %}
                          {% if order.items_count > 3 %}
                            <span class="more-items">+{{ order.items_count|add:'-3' }}</span>
                          {% endif %}
                        </div>

                        <!-- Order Info -->
                        <div class="order-info">
                          <div class="info-row">
                            <span>وضعیت</span>
                            <span class="status {{ status_mapping|get_item:order.status|get_item:'class' }}">{{ status_mapping|get_item:order.status|get_item:'label' }}</span>
                          </div>
                          <div class="info-row">
                            <span>مواد</span>
                            <span>{{ order.items_count }} مورد</span>
                          </div>
                          <div class="info-row">
                            <span>جمع کل</span>
                            <span class="price">{{ order.total|intcomma }} تومان</span>
                          </div>
                        </div>
                      </div>

                      <div class="order-footer">
                        <button type="button" class="btn-track" data-bs-toggle="collapse" data-bs-target="#tracking{{ order.id }}" aria-expanded="false">پیگیری سفارش</button>
                        <button type="button" class="btn-details" data-bs-toggle="collapse" data-bs-target="#details{{ order.id }}" aria-expanded="false">مشاهده جزئیات</button>
                      </div>

                      <!-- Order Tracking -->
                      <div class="collapse tracking-info" id="tracking{{ order.id }}">
                        <div class="tracking-timeline">
                          <!-- Pending -->
                          <div class="timeline-item {% if order.status == 'pending' %}active{% endif %} {% if order.status != 'pending' and order.status != 'cancelled' %}completed{% endif %}">
                            <div class="timeline-icon">
                              <i class="bi {% if order.status != 'pending' and order.status != 'cancelled' %}
                                  
                                  bi-check-circle-fill

                                {% else %}
                                  
                                  bi-clock

                                {% endif %}">

                              </i>
                            </div>
                            <div class="timeline-content">
                              <h5>در انتظار بررسی</h5>
                              <p>سفارش شما ثبت شده و در انتظار تایید پرداخت است</p>
                              <span class="timeline-date">{{ order.created_date|date:'j F Y - H:i' }}</span>
                            </div>
                          </div>

                          <!-- Processing -->
                          <div class="timeline-item {% if order.status == 'processing' %}active{% endif %} {% if order.status == 'shipped' or order.status == 'delivered' %}completed{% endif %}">
                            <div class="timeline-icon">
                              <i class="bi {% if order.status == 'shipped' or order.status == 'delivered' %}
                                  
                                  bi-check-circle-fill

                                {% else %}
                                  
                                  bi-box-seam

                                {% endif %}">

                              </i>
                            </div>
                            <div class="timeline-content">
                              <h5>در حال پردازش</h5>
                              <p>سفارش شما در حال آماده‌سازی برای ارسال است</p>
                              {% if order.status != 'pending' and order.status != 'cancelled' %}
                                <span class="timeline-date">{{ order.updated_date|date:'j F Y - H:i' }}</span>
                              {% endif %}
                            </div>
                          </div>

                          <!-- Shipped -->
                          <div class="timeline-item {% if order.status == 'shipped' %}active{% endif %} {% if order.status == 'delivered' %}completed{% endif %}">
                            <div class="timeline-icon">
                              <i class="bi {% if order.status == 'delivered' %}
                                  
                                  bi-check-circle-fill

                                {% else %}
                                  
                                  bi-truck

                                {% endif %}">

                              </i>
                            </div>
                            <div class="timeline-content">
                              <h5>ارسال شده</h5>
                              <p>سفارش شما به شرکت پستی تحویل داده شده است</p>
                              {% if order.status == 'shipped' or order.status == 'delivered' %}
                                <span class="timeline-date">{{ order.updated_date|date:'j F Y - H:i' }}</span>
                              {% endif %}
                            </div>
                          </div>

                          <!-- Delivered -->
                          <div class="timeline-item {% if order.status == 'delivered' %}active completed{% endif %}">
                            <div class="timeline-icon">
                              <i class="bi {% if order.status == 'delivered' %}
                                  
                                  bi-check-circle-fill

                                {% else %}
                                  
                                  bi-house-door

                                {% endif %}">

                              </i>
                            </div>
                            <div class="timeline-content">
                              <h5>تحویل داده شده</h5>
                              <p>سفارش با موفقیت تحویل گرفته شده است</p>
                              {% if order.status == 'delivered' %}
                                <span class="timeline-date">{{ order.updated_date|date:'j F Y - H:i' }}</span>
                              {% endif %}
                            </div>
                          </div>

                          <!-- Cancelled (if applicable) -->
                          {% if order.status == 'cancelled' %}
                            <div class="timeline-item cancelled active">
                              <div class="timeline-icon">
                                <i class="bi bi-x-circle-fill"></i>
                              </div>
                              <div class="timeline-content">
                                <h5>لغو شده</h5>
                                <p>این سفارش لغو شده است</p>
                                <span class="timeline-date">{{ order.updated_date|date:'j F Y - H:i' }}</span>
                              </div>
                            </div>
                          {% endif %}
                        </div>
                      </div>

                      <!-- Order Details -->
                      <div class="collapse order-details" id="details{{ order.id }}">
                        <div class="details-content">
                          <!-- Order Information -->
                          <div class="detail-section">
                            <h5>اطلاعات سفارش</h5>
                            <div class="info-grid">
                              <div class="info-item">
                                <span class="label">شماره سفارش</span>
                                <span class="value">{{ order.order_number }}</span>
                              </div>
                              <div class="info-item">
                                <span class="label">تاریخ ثبت</span>
                                <span class="value">{{ order.created_date|date:'j F Y - H:i' }}</span>
                              </div>
                              <div class="info-item">
                                <span class="label">وضعیت</span>
                                <span class="value">{{ status_mapping|get_item:order.status|get_item:'label' }}</span>
                              </div>
                            </div>
                          </div>

                          <!-- Order Items -->
                          <div class="detail-section">
                            <h5>محصولات ({{ order.items_count }})</h5>
                            <div class="order-items">
                              {% for item in order.items.all %}
                                <div class="item">
                                  {% if item.product.image %}
                                    <img src="{{ item.product.image.url }}" alt="{{ item.product_name }}" loading="lazy" />
                                  {% else %}
                                    <img src="{% static 'assets/img/placeholder.webp' %}" alt="{{ item.product_name }}" loading="lazy" />
                                  {% endif %}
                                  <div class="item-info">
                                    <h6>{{ item.product_name }}</h6>
                                    <div class="item-meta">
                                      <span class="sku">کد: {{ item.product.id }}</span>
                                      <span class="qty">تعداد: {{ item.quantity }}</span>
                                    </div>
                                  </div>
                                  <div class="item-price">{{ item.subtotal|intcomma }} تومان</div>
                                </div>
                              {% endfor %}
                            </div>
                          </div>

                          <!-- Price Details -->
                          <div class="detail-section">
                            <h5>جزئیات قیمت</h5>
                            <div class="price-breakdown">
                              <div class="price-row">
                                <span>جمع جزء</span>
                                <span>{{ order.subtotal|intcomma }} تومان</span>
                              </div>
                              <div class="price-row">
                                <span>هزینه ارسال</span>
                                <span>{{ order.shipping_cost|intcomma }} تومان</span>
                              </div>
                              <div class="price-row total">
                                <span>جمع کل</span>
                                <span>{{ order.total|intcomma }} تومان</span>
                              </div>
                            </div>
                          </div>

                          <!-- Shipping Address -->
                          <div class="detail-section">
                            <h5>آدرس ارسال</h5>
                            <div class="address-info">
                              <p>
                                {{ order.shipping_full_name }}<br />
                                {{ order.shipping_address_line1 }}<br />
                                {% if order.shipping_address_line2 %}
                                  {{ order.shipping_address_line2 }}<br />
                                {% endif %}
                                {{ order.shipping_city }}، {{ order.shipping_state }}<br />
                                کد پستی: {{ order.shipping_postal_code }}<br />
                                {{ order.shipping_country }}
                              </p>
                              <p class="contact">{{ order.shipping_phone }}</p>
                            </div>
                          </div>

                          {% if order.notes %}
                            <div class="detail-section">
                              <h5>یادداشت‌ها</h5>
                              <p>{{ order.notes }}</p>
                            </div>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                </div>

                <!-- Pagination -->
                {% if is_paginated %}
                  <div class="pagination-wrapper" data-aos="fade-up">
                    {% if page_obj.has_previous %}
                      <a href="?page={{ page_obj.previous_page_number }}{% if current_status != 'all' %}
                          
                          &status={{ current_status }}
                        {% endif %}{% if search_query %}
                          
                          &search={{ search_query }}
                        {% endif %}"
                        class="btn-prev">
                        <i class="bi bi-chevron-right"></i>
                      </a>
                    {% else %}
                      <button type="button" class="btn-prev" disabled><i class="bi bi-chevron-right"></i></button>
                    {% endif %}

                    <div class="page-numbers">
                      {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                          <button type="button" class="active">{{ num }}</button>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                          <a href="?page={{ num }}{% if current_status != 'all' %}
                              
                              &status={{ current_status }}
                            {% endif %}{% if search_query %}
                              
                              &search={{ search_query }}
                            {% endif %}">
                            {{ num }}
                          </a>
                        {% endif %}
                      {% endfor %}
                    </div>

                    {% if page_obj.has_next %}
                      <a href="?page={{ page_obj.next_page_number }}{% if current_status != 'all' %}
                          
                          &status={{ current_status }}
                        {% endif %}{% if search_query %}
                          
                          &search={{ search_query }}
                        {% endif %}"
                        class="btn-next">
                        <i class="bi bi-chevron-left"></i>
                      </a>
                    {% else %}
                      <button type="button" class="btn-next" disabled><i class="bi bi-chevron-left"></i></button>
                    {% endif %}
                  </div>
                {% endif %}
              {% else %}
                <!-- Empty State -->
                <div class="empty-state" data-aos="fade-up">
                  <i class="bi bi-box-seam"></i>
                  <h3>هیچ سفارشی یافت نشد</h3>
                  <p>شما هنوز سفارشی ثبت نکرده‌اید</p>
                  <a href="{% url 'shop:product_list' %}" class="btn btn-primary">مشاهده محصولات</a>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
{% endblock %}
