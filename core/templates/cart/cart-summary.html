{% extends "base.html" %}
{% load static %}
{% block title %}Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯{% endblock %}
{% block content %}

<!-- ===== Slider ===== -->
<div class="slider-area">
  <div class="single-slider slider-height2 d-flex align-items-center" data-background="{% static 'img/hero/category.jpg' %}">
    <div class="container">
      <div class="row">
        <div class="col-xl-12">
          <div class="hero-cap text-center">
            <h2>Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯</h2>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== Cart Area ===== -->
<section class="cart_area section_padding">
  <div class="container">
    {% if cart_items %}
    <div class="cart_inner">
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th scope="col">Ù…Ø­ØµÙˆÙ„</th>
              <th scope="col">Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯</th>
              <th scope="col">ØªØ¹Ø¯Ø§Ø¯</th>
              <th scope="col">Ø¬Ù…Ø¹ Ú©Ù„</th>
              <th scope="col">Ø¹Ù…Ù„ÛŒØ§Øª</th>
            </tr>
          </thead>
          <tbody>
            {% for item in cart_items %}
            <tr data-product-id="{{ item.product_obj.id }}">
              <td>
                <div class="media align-items-center">
                  <div class="d-flex">
                    <img src="{{ item.product_obj.image.url }}" alt="{{ item.product_obj.name }}" width="80">
                  </div>
                  <div class="media-body pl-3">
                    <p>{{ item.product_obj.name }}</p>
                  </div>
                </div>
              </td>
              <td>
                <h5 class="unit-price">${{ item.product_obj.get_price }}</h5>
              </td>
              <td>
                <div class="product_count d-inline-flex align-items-center">
                  <span class="input-number-decrement"><i class="ti-minus"></i></span>
                  <input class="input-number qty-input" type="text" value="{{ item.quantity }}" min="1" max="10">
                  <span class="input-number-increment"><i class="ti-plus"></i></span>
                </div>
              </td>
              <td>
                <h5 class="item-total">${{ item.total_price }}</h5>
              </td>
              <td>
                <button class="btn btn-sm btn-danger remove-item-btn">Ø­Ø°Ù</button>
              </td>
            </tr>
            {% endfor %}

            <tr>
              <td colspan="3" class="text-right">
                <h5>Ø¬Ù…Ø¹ Ú©Ù„:</h5>
              </td>
              <td>
                <h5 id="cart-total">${{ total_payment_price }}</h5>
              </td>
            </tr>
          </tbody>
        </table>

        <div class="checkout_btn_inner float-right">
          <a class="btn_1" href="{% url 'shop:product-list' %}">Ø§Ø¯Ø§Ù…Ù‡ Ø®Ø±ÛŒØ¯</a>
          <a class="btn_1 checkout_btn_1" href="#">ØªØ³ÙˆÛŒÙ‡ Ø­Ø³Ø§Ø¨</a>
        </div>
      </div>
    </div>
    {% else %}
    <p class="text-center mt-5">Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø´Ù…Ø§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª ğŸ˜”</p>
    {% endif %}
  </div>
</section>

<!-- ===== Scripts ===== -->
<script>
// --- Ø¯Ø±ÛŒØ§ÙØª CSRF ---
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
      cookie = cookie.trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
const csrftoken = getCookie('csrftoken');

// --- Ø§ÙØ²Ø§ÛŒØ´ / Ú©Ø§Ù‡Ø´ ØªØ¹Ø¯Ø§Ø¯ ---
document.querySelectorAll('.product_count').forEach(wrapper => {
  const input = wrapper.querySelector('.qty-input');
  const plus = wrapper.querySelector('.input-number-increment');
  const minus = wrapper.querySelector('.input-number-decrement');
  const row = wrapper.closest('tr');
  const productId = row.dataset.productId;

  // Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ù„ÛŒÚ© Ø¨Ø± Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ø§ÙØ²Ø§ÛŒØ´
  plus.addEventListener('click', () => {
    const currentValue = parseInt(input.value);
    if (currentValue < 10) {
      updateQuantity(productId, currentValue + 1, row);
    }
  });

  // Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ù„ÛŒÚ© Ø¨Ø± Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ú©Ø§Ù‡Ø´
  minus.addEventListener('click', () => {
    const currentValue = parseInt(input.value);
    if (currentValue > 1) {
      updateQuantity(productId, currentValue - 1, row);
    }
  });

  // Ù…Ø¯ÛŒØ±ÛŒØª ØªØºÛŒÛŒØ± Ù…Ø³ØªÙ‚ÛŒÙ… Ù…Ù‚Ø¯Ø§Ø± Ø¯Ø± input
  input.addEventListener('change', () => {
    let newValue = parseInt(input.value);
    if (isNaN(newValue) || newValue < 1) newValue = 1;
    if (newValue > 10) newValue = 10;
    updateQuantity(productId, newValue, row);
  });
});

// --- ØªØ§Ø¨Ø¹ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªØ¹Ø¯Ø§Ø¯ ---
function updateQuantity(productId, quantity, row) {
  fetch("{% url 'cart:session-update-product-quantity' %}", {
    method: "POST",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded",
      "X-CSRFToken": csrftoken
    },
    body: new URLSearchParams({
      "product_id": productId,
      "quantity": quantity
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…Ù‚Ø¯Ø§Ø± input
      const input = row.querySelector('.qty-input');
      input.value = quantity;
      
      // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¬Ù…Ø¹ Ú©Ù„ Ø¢ÛŒØªÙ…
      const itemTotal = row.querySelector('.item-total');
      const unitPrice = parseFloat(row.querySelector('.unit-price').textContent.replace('$', ''));
      itemTotal.textContent = '$' + (unitPrice * quantity).toFixed(2);
      
      // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¬Ù…Ø¹ Ú©Ù„ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯
      document.getElementById('cart-total').textContent = '$' + data.total_payment_price;
      
      // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ Ø¯Ø± Ù‡Ø¯Ø± (Ø§Ú¯Ø± Ø§Ù„Ù…Ø§Ù† Ù…Ø±Ø¨ÙˆØ·Ù‡ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯)
      const cartCount = document.getElementById('cart-count');
      if (cartCount) {
        cartCount.textContent = data.total_quantity;
      }
    } else {
      console.error("Error updating quantity:", data.message);
    }
  })
  .catch(err => console.error("Error updating quantity:", err));
}

// --- Ø­Ø°Ù Ù…Ø­ØµÙˆÙ„ Ø§Ø² Ø³Ø¨Ø¯ ---
document.querySelectorAll('.remove-item-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    const row = this.closest('tr');
    const productId = row.dataset.productId;

    fetch("{% url 'cart:session-remove-product' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": csrftoken
      },
      body: new URLSearchParams({ "product_id": productId })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        row.remove();
        document.getElementById('cart-total').textContent = '$' + data.total_payment_price;
        
        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ Ø¯Ø± Ù‡Ø¯Ø±
        const cartCount = document.getElementById('cart-count');
        if (cartCount) {
          cartCount.textContent = data.total_quantity;
        }
        
        // Ø§Ú¯Ø± Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø®Ø§Ù„ÛŒ Ø´Ø¯ØŒ ØµÙØ­Ù‡ Ø±Ø§ Ø±ÙØ±Ø´ Ú©Ù†
        if (data.total_quantity === 0) {
          location.reload();
        }
      } else {
        console.error("Error removing item:", data.message);
      }
    })
    .catch(err => console.error("Error removing item:", err));
  });
});
</script>

{% endblock %}