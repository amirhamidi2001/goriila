{% extends "base.html" %}
{% load static %}
{% block content %}

<!-- slider Area Start-->
<div class="slider-area ">
  <!-- Mobile Menu -->
  <div class="single-slider slider-height2 d-flex align-items-center" data-background="{% static 'img/hero/category.jpg' %}">
    <div class="container">
      <div class="row">
        <div class="col-xl-12">
          <div class="hero-cap text-center">
            <h2>Cart List</h2>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- slider Area End-->

  <!--================Cart Area =================-->
  <section class="cart_area section_padding">
    <div class="container">
      <div class="cart_inner">
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th scope="col">Product</th>
                <th scope="col">Price</th>
                <th scope="col">Quantity</th>
                <th scope="col">Total</th>
                <th scope="col">Action</th>
              </tr>
            </thead>
            <tbody>
              {% for item in cart_items %}
              <tr id="cart-item-{{ item.product_id }}">
                <td>
                  <div class="media">
                    <div class="d-flex">
                      <img src="{{ item.product_obj.image.url|default:'assets/img/arrivel/arrivel_1.png' }}" alt="{{ item.product_obj.name }}" width="100" />
                    </div>
                    <div class="media-body">
                      <p>{{ item.product_obj.name }}</p>
                    </div>
                  </div>
                </td>
                <td>
                  <h5>${{ item.product_obj.get_price }}</h5>
                </td>
                <td>
                  <div class="product_count">
                    <span class="input-number-decrement" onclick="updateQuantity({{ item.product_id }}, -1)"> 
                      <i class="ti-minus"></i>
                    </span>
                    <input class="input-number" type="text" value="{{ item.quantity }}" min="1" max="{{ item.product_obj.stock }}" id="quantity-{{ item.product_id }}">
                    <span class="input-number-increment" onclick="updateQuantity({{ item.product_id }}, 1)"> 
                      <i class="ti-plus"></i>
                    </span>
                  </div>
                </td>
                <td>
                  <h5 id="total-{{ item.product_id }}">${{ item.total_price }}</h5>
                </td>
                <td>
                  <button class="btn btn-danger btn-sm" onclick="removeProduct({{ item.product_id }})">
                    <i class="ti-trash"></i> Remove
                  </button>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="5" class="text-center">
                  <h5>Your cart is empty</h5>
                </td>
              </tr>
              {% endfor %}
              
              {% if cart_items %}
              <tr class="bottom_button">
                <td>
                  <a class="btn_1" href="#" onclick="updateAllQuantities()">Update Cart</a>
                </td>
                <td></td>
                <td></td>
                <td></td>
                <td>
                  <a class="btn_1" href="#" onclick="clearCart()">Clear Cart</a>
                </td>
              </tr>
              <tr>
                <td></td>
                <td></td>
                <td>
                  <h5>Subtotal</h5>
                </td>
                <td>
                  <h5 id="subtotal-price">${{ total_payment_price }}</h5>
                </td>
                <td></td>
              </tr>
              <tr>
                <td></td>
                <td></td>
                <td>
                  <h5>Total Quantity</h5>
                </td>
                <td>
                  <h5 id="total-quantity">{{ total_quantity }} items</h5>
                </td>
                <td></td>
              </tr>
              {% endif %}
            </tbody>
          </table>
          <div class="checkout_btn_inner float-right">
            <a class="btn_1" href="{% url 'shop:shop' %}">Continue Shopping</a>
            {% if cart_items %}
            <a class="btn_1 checkout_btn_1" href="#">Proceed to checkout</a>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </section>
  <!--================End Cart Area =================-->

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function updateQuantity(productId, change) {
    const quantityInput = document.getElementById(`quantity-${productId}`);
    let newQuantity = parseInt(quantityInput.value) + change;
    const maxStock = parseInt(quantityInput.max);
    
    if (newQuantity < 1) newQuantity = 1;
    if (newQuantity > maxStock) newQuantity = maxStock;
    
    quantityInput.value = newQuantity;
    updateProductQuantity(productId, newQuantity);
}

function updateProductQuantity(productId, quantity) {
    const csrftoken = getCookie('csrftoken');
    
    fetch("{% url 'cart:session-update-product-quantity' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrftoken
        },
        body: `product_id=${productId}&quantity=${quantity}`
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById(`total-${productId}`).textContent = `$${(data.cart.items.find(item => item.product_id === productId)?.quantity || 0) * getProductPrice(productId)}`;
        document.getElementById('subtotal-price').textContent = `$${calculateSubtotal(data.cart)}`;
        document.getElementById('total-quantity').textContent = `${data.total_quantity} items`;
    })
    .catch(error => console.error('Error:', error));
}

function removeProduct(productId) {
    const csrftoken = getCookie('csrftoken');
    
    fetch("{% url 'cart:session-remove-product' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrftoken
        },
        body: `product_id=${productId}`
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById(`cart-item-${productId}`).remove();
        document.getElementById('subtotal-price').textContent = `$${calculateSubtotal(data.cart)}`;
        document.getElementById('total-quantity').textContent = `${data.total_quantity} items`;
        
        if (data.total_quantity === 0) {
            location.reload();
        }
    })
    .catch(error => console.error('Error:', error));
}

function updateAllQuantities() {
    {% for item in cart_items %}
    const quantityInput{{ item.product_id }} = document.getElementById('quantity-{{ item.product_id }}');
    updateProductQuantity({{ item.product_id }}, parseInt(quantityInput{{ item.product_id }}.value));
    {% endfor %}
}

function clearCart() {
    const csrftoken = getCookie('csrftoken');
    
    fetch("{% url 'cart:session-remove-product' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrftoken
        },
        body: 'clear_all=true'
    })
    .then(response => response.json())
    .then(data => {
        location.reload();
    })
    .catch(error => console.error('Error:', error));
}

function getProductPrice(productId) {
    // This would need to be implemented based on your product data structure
    // For now, using a simple approach - you might need to adjust this
    const productRow = document.getElementById(`cart-item-${productId}`);
    const priceText = productRow.querySelector('td:nth-child(2) h5').textContent;
    return parseFloat(priceText.replace('$', ''));
}

function calculateSubtotal(cartData) {
    let subtotal = 0;
    cartData.items.forEach(item => {
        subtotal += (item.quantity * getProductPrice(item.product_id));
    });
    return subtotal.toFixed(2);
}
</script>

{% endblock %}