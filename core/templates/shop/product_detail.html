{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% block title %}
  {{ product.name }} | فروشگاه اینترنتی مکمل گوریلا
{% endblock %}
{% block content %}
  <main class="main">
    <!-- Page Title -->
    <div class="page-title light-background">
      <div class="container d-lg-flex justify-content-between align-items-center">
        <h1 class="mb-2 mb-lg-0">{{ product.name }}</h1>
        <nav class="breadcrumbs">
          <ol>
            <li>
              <a href="{% url 'website:index' %}">صفحه اصلی</a>
            </li>
            <li class="current">{{ product.name }}</li>
          </ol>
        </nav>
      </div>
    </div>
    <!-- End Page Title -->

    <!-- Product Details Section -->
    <section id="product-details" class="product-details section">
      <div class="container" data-aos="fade-up" data-aos-delay="100">
        <div class="row g-4">
          <!-- Product Gallery -->
          <div class="col-lg-7" data-aos="zoom-in" data-aos-delay="150">
            <div class="product-gallery">
              <div class="main-showcase">
                <div class="image-zoom-container">
                  <img src="{{ product.image.url }}" alt="Product Main" class="img-fluid main-product-image drift-zoom" id="main-product-image" data-zoom="{{ product.image.url }}" />
                  <div class="image-navigation">
                    <button class="nav-arrow prev-image image-nav-btn prev-image" type="button"><i class="bi bi-chevron-right"></i></button>
                    <button class="nav-arrow next-image image-nav-btn next-image" type="button"><i class="bi bi-chevron-left"></i></button>
                  </div>
                </div>
              </div>
              <div class="thumbnail-grid">
                <div class="thumbnail-wrapper thumbnail-item active" data-image="{{ product.image.url }}">
                  <img src="{{ product.image.url }}" alt="View 1" class="img-fluid" />
                </div>
                <div class="thumbnail-wrapper thumbnail-item" data-image="{{ product.hologram.url }}">
                  <img src="{{ product.hologram.url }}" alt="View 2" class="img-fluid" />
                </div>
              </div>
            </div>
          </div>

          <!-- Product Details -->
          <div class="col-lg-5" data-aos="fade-left" data-aos-delay="200">
            <div class="product-details">
              <div class="product-badge-container">
                <span class="badge-category">{{ product.category.name }}</span>
                <span class="badge-category">{{ product.brand.name }}</span>
                {% load rating_tags %}
                {% with s=product.rating|star_parts %}
                  <div class="rating-group">
                    <div class="stars">
                      {% for _ in s.empty %}
                        <i class="bi bi-star"></i>
                      {% endfor %}
                      {% for _ in s.half %}
                        <i class="bi bi-star-half"></i>
                      {% endfor %}
                      {% for _ in s.full %}
                        <i class="bi bi-star-fill"></i>
                      {% endfor %}
                    </div>
                  </div>
                {% endwith %}
              </div>
              <h1 class="product-name">{{ product.name }}</h1>
              {% if product.discount > 0 %}
                <div class="pricing-section">
                  <div class="price-display">
                    <span class="sale-price formatted-price">{{ product.get_price }}</span>
                    <span class="regular-price formatted-price">{{ product.price }}</span>
                  </div>
                  <div class="savings-info">
                    <span class="save-amount">سود شما&nbsp;{{ product.discount_amount }}&nbsp;تومان</span>
                    <span class="discount-percent">({{ product.discount }}% تخفیف )</span>
                  </div>
                </div>
              {% else %}
                <div class="pricing-section">
                  <div class="price-display">
                    <span class="sale-price formatted-price">{{ product.get_price }}</span>
                  </div>
                </div>
              {% endif %}
              <div class="product-description">
                <p>{{ product.breif_description }}</p>
              </div>
              <div class="availability-status">
                <div class="stock-indicator">
                  {% if product.available %}
                    <i class="bi bi-check-circle-fill"></i>
                    <span class="stock-text">موجود</span>
                  {% else %}
                    <span class="stock-indicatorn"><i class="bi bi-x-circle-fill"></i></span>
                    <span class="stock-text">نا موجود</span>
                  {% endif %}
                </div>
                <div class="quantity-left">فقط {{ product.stock }} کالا باقی مانده است</div>
              </div>

              <!-- Purchase Options -->
              <div class="purchase-section">
                <div class="quantity-control">
                  <label class="control-label">تعداد:</label>
                  <div class="quantity-input-group">
                    <div class="quantity-selector">
                      <button class="quantity-btn decrease" type="button" onclick="decreaseFromCart({{ product.id }})"><i class="bi bi-dash"></i></button>
                      <input id="quantity-{{ product.id }}" class="quantity-input" value="{{ product_cart_quantity }}" min="1" max="{{ product.stock }}" readonly />
                      <button class="quantity-btn increase" type="button" onclick="addToCart({{ product.id }})"><i class="bi bi-plus"></i></button>
                    </div>
                  </div>
                </div>
                <div class="action-buttons">
                  <button class="btn icon-action" type="button" onclick="removeProduct('{{ product.id }}')" title="حذف کالا از سبد خرید"><i class="bi bi-trash"></i></button>
                  <button type="button" onclick="addToCart({{ product.id }})" id="add-to-cart-btn" class="btn primary-action">
                    <i class="bi bi-bag-plus"></i>
                    افزودن به سبد خرید
                  </button>
                  <button class="btn icon-action"
                    id="wishlist-btn-{{ product.id }}"
                    onclick="toggleWishlist({{ product.id }})"
                    title="{% if is_in_wishlist %}
                      
                      حذف از لیست علاقه‌مندی‌ها

                    {% else %}
                      
                      افزودن به لیست علاقه‌مندی‌ها

                    {% endif %}">
                    <i class="bi bi-heart{% if is_in_wishlist %}-fill{% endif %}" id="wishlist-icon-{{ product.id }}"></i>
                  </button>
                </div>
              </div>

              <!-- Benefits List -->
              <div class="benefits-list">
                <div class="benefit-item">
                  <i class="bi bi-truck"></i>
                  <span>ارسال به سراسر ایران</span>
                </div>
                <div class="benefit-item">
                  <i class="bi bi-arrow-clockwise"></i>
                  <span>امکان عودت وجه و تعویض کالا</span>
                </div>
                <div class="benefit-item">
                  <i class="bi bi-shield-check"></i>
                  <span>ضمانت اصالت کالا</span>
                </div>
                <div class="benefit-item">
                  <i class="bi bi-headset"></i>
                  <span>امکان ثبت سفارش 24/7</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Information Tabs -->
        <div class="row mt-5" data-aos="fade-up" data-aos-delay="300">
          <div class="col-12">
            <div class="info-tabs-container">
              <nav class="tabs-navigation nav">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#ecommerce-product-details-5-overview" type="button">نمای کلی</button>
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#ecommerce-product-details-5-technical" type="button">جزئیات</button>
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#ecommerce-product-details-5-customer-reviews" type="button">نظرات ({{ product.reviews.count }})</button>
              </nav>
              <div class="tab-content">
                <!-- Overview Tab -->
                <div class="tab-pane fade show active" id="ecommerce-product-details-5-overview">
                  <div class="overview-content">
                    <div class="row g-4">
                      <div class="col-lg-8">
                        <div class="content-section">
                          <h3>بررسی اجمالی محصول</h3>
                          <p>{{ product.description }}</p>
                          <h4>نکات برجسته</h4>
                          <div class="highlights-grid">
                            <div class="highlight-card">
                              <i class="bi bi-shield-check"></i>
                              <h5>بدون روغن پالم</h5>
                            </div>
                            <div class="highlight-card">
                              <i class="bi bi-thermometer-half"></i>
                              <h5>کاهش محتوای لاکتوز</h5>
                            </div>
                            <div class="highlight-card">
                              <i class="bi bi-slash-circle"></i>
                              <h5>بدون گلوتن</h5>
                            </div>
                            <div class="highlight-card">
                              <i class="bi bi-heart-pulse"></i>
                              <h5>بدون قند</h5>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Technical Details Tab -->
                <div class="tab-pane fade" id="ecommerce-product-details-5-technical">
                  <div class="technical-content">
                    <div class="row g-4">
                      <div class="col-md-6">
                        <div class="tech-group">
                          <h4>مشخصات تکمیلی</h4>
                          <div class="spec-table">
                            <div class="spec-row">
                              <span class="spec-name">برند</span>
                              <span class="spec-value">{{ product.brand.name }}</span>
                            </div>
                            <div class="spec-row">
                              <span class="spec-name">دسته بندی</span>
                              <span class="spec-value">{{ product.category.name }}</span>
                            </div>
                            <div class="spec-row">
                              <span class="spec-name">وزن</span>
                              <span class="spec-value">{{ product.weight }}</span>
                            </div>
                            <div class="spec-row">
                              <span class="spec-name">طعم</span>
                              <span class="spec-value">{{ product.taste }}</span>
                            </div>
                            <div class="spec-row">
                              <span class="spec-name">ایزوله خالص</span>
                              <span class="spec-value">100%</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Reviews Tab -->
                <div class="tab-pane fade" id="ecommerce-product-details-5-customer-reviews">
                  <div class="reviews-content">
                    <div class="reviews-header">
                      <div class="rating-overview">
                        <div class="average-score">
                          <div class="score-display">{{ product.rating }}</div>
                          {% with s=product.rating|star_parts %}
                            <div class="score-stars">
                              {% for _ in s.empty %}
                                <i class="bi bi-star"></i>
                              {% endfor %}
                              {% for _ in s.half %}
                                <i class="bi bi-star-half"></i>
                              {% endfor %}
                              {% for _ in s.full %}
                                <i class="bi bi-star-fill"></i>
                              {% endfor %}
                            </div>
                          {% endwith %}
                          <div class="total-reviews">{{ product.reviews.count }} نظر ثبت شده</div>
                        </div>
                      </div>
                      <div class="write-review-cta">
                        <h4>تجربه خود را به اشتراک بگذارید</h4>
                        <p>به دیگران کمک کنید تا تصمیمات آگاهانه بگیرند</p>
                        <button class="btn review-btn">ثبت نظر</button>
                      </div>
                    </div>
                    <div class="customer-reviews-list">
                      {% for review in reviews %}
                        <div class="review-card">
                          <div class="reviewer-profile">
                            <div class="profile-details">
                              <div class="customer-name">{{ review.name }}</div>
                            </div>
                          </div>
                          <h6 class="review-headline">{{ review.created_at|naturaltime }}</h6>
                          <div class="review-text">
                            <p>{{ review.review }}</p>
                          </div>
                        </div>
                      {% endfor %}
                      <!-- Shop review Form Section -->
                      <section id="blog-comment-form" class="blog-comment-form section">
                        <div class="container" data-aos="fade-up" data-aos-delay="100">
                          <form method="post" role="form">
                            {% csrf_token %}
                            <div class="form-header">
                              <h3>ثبت نظر</h3>
                              <p>آدرس ایمیل شما منتشر نخواهد شد. فیلدهای ضروری با * مشخص شده‌اند.</p>
                            </div>
                            <div class="row gy-3">
                              <div class="col-md-6">
                                <div class="input-group">
                                  <label for="name">نام و نام خانوادگی *</label>
                                  <input type="text" name="name" id="name" placeholder="نام و نام خانوادگی خود را وارد کنید" required="" />
                                  <span class="error-text">لطفاً نام خود را وارد کنید</span>
                                </div>
                              </div>
                              <div class="col-md-6">
                                <div class="input-group">
                                  <label for="email">آدرس ایمیل *</label>
                                  <input type="email" name="email" id="email" placeholder="آدرس ایمیل خود را وارد کنید" required="" />
                                  <span class="error-text">لطفاً یک آدرس ایمیل معتبر وارد کنید</span>
                                </div>
                              </div>
                              <div class="col-12">
                                <div class="input-group">
                                  <label for="website">وب‌سایت</label>
                                  <input type="url" name="website" id="website" placeholder="وب‌سایت شما (اختیاری)" />
                                </div>
                              </div>
                              <div class="col-12">
                                <div class="input-group">
                                  <label for="comment">نظر شما *</label>
                                  <textarea name="review" id="review" rows="5" placeholder="اینجا نظر خود را بنویسید..." required=""></textarea>
                                  <span class="error-text">لطفاً نظر خود را وارد کنید</span>
                                </div>
                              </div>
                              <div class="col-12 text-center">
                                <button type="submit">ارسال نظر</button>
                              </div>
                            </div>
                          </form>
                        </div>
                      </section>
                      <!-- /Shop review Form Section -->
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- /Product Details Section -->
  </main>

  <!-- jQuery and AJAX script -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script>
    function removeProduct(product_id) {
      $.ajax({
        url: "{% url 'cart:session-remove-product' %}",
        type: 'POST',
        data: {
          product_id: product_id,
          csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function (response) {
          $('#total-cart-item-count').text(response.total_quantity)
          $('#quantity-' + product_id).val(0)
          $('#cart-item-' + product_id).remove()
          if (response.total_quantity === 0) {
            $('#empty-cart-message').show()
          }
        },
        error: function (xhr) {
          console.error(xhr)
        }
      })
    }
  </script>
  <script>
    function addToCart(product_id) {
      $.ajax({
        url: "{% url 'cart:session-add-product' %}",
        type: 'POST',
        data: {
          product_id: product_id,
          csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function (response) {
          if (response.added === false) {
            alert('تعداد انتخاب شده بیشتر از موجودی محصول است.')
            return
          }
          $('#total-cart-item-count').html(response.total_quantity)
          let item = response.cart.items.find((i) => i.product_id == product_id)
          if (item) {
            $('#quantity-' + product_id).val(item.quantity)
          }
        },
        error: function (xhr, status, error) {
          console.error(error)
        }
      })
    }
  </script>
  <script>
    function decreaseFromCart(product_id) {
      $.ajax({
        url: "{% url 'cart:session-decrease-product' %}",
        type: 'POST',
        data: {
          product_id: product_id,
          csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function (response) {
          if (response.decreased === false) {
            alert('امکان کم کردن بیشتر وجود ندارد.')
            return
          }
          $('#total-cart-item-count').html(response.total_quantity)
          let item = response.cart.items.find((i) => i.product_id == product_id)
          if (item) {
            $('#quantity-' + product_id).val(item.quantity)
          }
        },
        error: function (xhr, status, error) {
          console.error(error)
        }
      })
    }
  </script>
  <script>
    function toggleWishlist(product_id) {
      {% if not user.is_authenticated %}
    alert('برای افزودن به لیست علاقه‌مندی‌ها ابتدا وارد حساب کاربری خود شوید.');
    window.location.href = "{% url 'accounts:login' %}?next={{ request.path }}";
    return;
  {% endif %}
      const icon = $('#wishlist-icon-' + product_id)
      const btn = $('#wishlist-btn-' + product_id)
    
      btn.prop('disabled', true)
    
      $.ajax({
        url: "{% url 'dashboard:wishlist_toggle' %}",
        type: 'POST',
        data: {
          product_id: product_id,
          csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function (response) {
          if (response.added) {
            icon.removeClass('bi-heart').addClass('bi-heart-fill')
            btn.attr('title', 'حذف از لیست علاقه‌مندی‌ها')
          } else {
            icon.removeClass('bi-heart-fill').addClass('bi-heart')
            btn.attr('title', 'افزودن به لیست علاقه‌مندی‌ها')
          }
    
          $('.wishlist-count').text(response.total_wishlist_items)
    
          console.log(response.message)
        },
        error: function (xhr) {
          if (xhr.status === 401 || xhr.status === 403) {
            alert('لطفاً ابتدا وارد حساب کاربری خود شوید.')
            window.location.href = "{% url 'accounts:login' %}?next={{ request.path }}"
          } else {
            alert('خطایی رخ داده است. لطفاً دوباره تلاش کنید.')
          }
          console.error(xhr)
        },
        complete: function () {
          btn.prop('disabled', false)
        }
      })
    }
  </script>
{% endblock %}
