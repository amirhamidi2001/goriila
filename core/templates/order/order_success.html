{% extends 'base.html' %}
{% load static %}

{% block title %}
  تسویه حساب
{% endblock %}

{% block content %}
  <div class="container my-5">
    <div class="row">
      <div class="col-lg-8">
        <div class="card">
          <div class="card-header">
            <h3>فرم تسویه حساب (ساده)</h3>
          </div>
          <div class="card-body">
            <form method="post" enctype="multipart/form-data">
              {% csrf_token %}

              <!-- نمایش خطاها -->
              {% if form.errors %}
                <div class="alert alert-danger">
                  <ul>
                    {% for field in form %}
                      {% for error in field.errors %}
                        <li>{{ field.label }}: {{ error }}</li>
                      {% endfor %}
                    {% endfor %}
                    {% for error in form.non_field_errors %}
                      <li>{{ error }}</li>
                    {% endfor %}
                  </ul>
                </div>
              {% endif %}

              <!-- بخش 1: انتخاب آدرس -->
              <div class="mb-4">
                <h5>1. انتخاب آدرس ارسال</h5>
                <hr />

                <div class="form-group">
                  <label>{{ form.address.label }}</label>

                  {% for choice in form.address %}
                    <div class="form-check mb-2">
                      {{ choice.tag }}
                      <label class="form-check-label" for="{{ choice.id_for_label }}">{{ choice.choice_label }}</label>
                    </div>
                  {% endfor %}

                  {% if form.address.errors %}
                    <div class="text-danger mt-2">{{ form.address.errors }}</div>
                  {% endif %}
                </div>

                <a href="{% url 'dashboard:addresses' %}" class="btn btn-sm btn-outline-primary mt-2">مدیریت آدرس‌ها</a>
              </div>

              <!-- بخش 2: اطلاعات پرداخت -->
              <div class="mb-4">
                <h5>2. اطلاعات پرداخت</h5>
                <hr />

                <div class="alert alert-info">
                  <strong>شماره کارت:</strong> {{ bank_card_number }}
                  <br />
                  <strong>مبلغ قابل پرداخت:</strong> {{ total|floatformat:2 }} تومان
                </div>

                <div class="form-group mb-3">
                  <label for="{{ form.payment_receipt.id_for_label }}">
                    {{ form.payment_receipt.label }}
                    <span class="text-danger">*</span>
                  </label>
                  {{ form.payment_receipt }}
                  {% if form.payment_receipt.errors %}
                    <div class="text-danger">{{ form.payment_receipt.errors }}</div>
                  {% endif %}
                </div>

                <div class="form-group">
                  <label for="{{ form.notes.id_for_label }}">{{ form.notes.label }}</label>
                  {{ form.notes }}
                  {% if form.notes.errors %}
                    <div class="text-danger">{{ form.notes.errors }}</div>
                  {% endif %}
                </div>
              </div>

              <!-- بخش 3: قبول شرایط و ثبت -->
              <div class="mb-4">
                <h5>3. قبول شرایط و ثبت سفارش</h5>
                <hr />

                <div class="form-check mb-3">
                  {{ form.terms }}
                  <label class="form-check-label" for="{{ form.terms.id_for_label }}">{{ form.terms.label }}</label>
                  {% if form.terms.errors %}
                    <div class="text-danger">{{ form.terms.errors }}</div>
                  {% endif %}
                </div>

                <button type="submit" class="btn btn-primary btn-lg w-100">ثبت سفارش - {{ total|floatformat:2 }} تومان</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- خلاصه سفارش -->
      <div class="col-lg-4">
        <div class="card">
          <div class="card-header">
            <h5>خلاصه سفارش</h5>
          </div>
          <div class="card-body">
            <h6>محصولات ({{ cart.get_total_items }} عدد):</h6>

            {% for item in cart.items.all %}
              <div class="d-flex justify-content-between mb-2">
                <span>{{ item.product.name }} × {{ item.quantity }}</span>
                <span>{{ item.get_total_price|floatformat:2 }}</span>
              </div>
            {% endfor %}

            <hr />

            <div class="d-flex justify-content-between mb-2">
              <span>جمع جزء:</span>
              <span>{{ subtotal|floatformat:2 }}</span>
            </div>

            <div class="d-flex justify-content-between mb-2">
              <span>هزینه ارسال:</span>
              <span>{{ shipping_cost|floatformat:2 }}</span>
            </div>

            <div class="d-flex justify-content-between mb-2">
              <span>مالیات:</span>
              <span>{{ tax|floatformat:2 }}</span>
            </div>

            <hr />

            <div class="d-flex justify-content-between">
              <strong>جمع کل:</strong>
              <strong class="text-primary">{{ total|floatformat:2 }} تومان</strong>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
