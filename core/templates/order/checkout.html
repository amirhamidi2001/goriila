{% extends 'base.html' %}
{% load static %}

{% block title %}
  تسویه حساب فروشگاه اینترنتی مکمل گوریلا
{% endblock %}

{% block content %}
  <main class="main">
    <!-- Page Title -->
    <div class="page-title light-background">
      <div class="container d-lg-flex justify-content-between align-items-center">
        <h1 class="mb-2 mb-lg-0">تسویه حساب</h1>
        <nav class="breadcrumbs">
          <ol>
            <li>
              <a href="{% url 'website:index' %}">صفحه اصلی</a>
            </li>
            <li class="current">تسویه حساب</li>
          </ol>
        </nav>
      </div>
    </div>
    <!-- End Page Title -->

    <!-- Checkout Section -->
    <section id="checkout" class="checkout section">
      <div class="container" data-aos="fade-up" data-aos-delay="100">
        <div class="row">
          <div class="col-lg-7">
            <!-- Checkout Form -->
            <div class="checkout-container" data-aos="fade-up">
              <div class="checkout-section" id="payment-method">
                <div class="section-header">
                  <div class="section-number">1</div>
                  <h3>روش پرداخت</h3>
                </div>
                <div class="section-content">
                  <div class="payment-options">
                    <div class="payment-option active">
                      <input type="radio" name="payment-method" id="credit-card" checked="" />
                      <label for="credit-card">
                        <span class="payment-icon"><i class="bi bi-credit-card-2-front"></i></span>
                        <span class="payment-label">6219861921574926</span>
                      </label>
                    </div>
                    <div class="payment-option">
                      <input type="radio" name="payment-method" id="paypal" />
                      <label for="paypal">
                        <span class="payment-icon"><i class="bi bi-credit-card-2-front"></i></span>
                        <span class="payment-label">6219861921574926</span>
                      </label>
                    </div>
                    <div class="payment-option">
                      <input type="radio" name="payment-method" id="apple-pay" />
                      <label for="apple-pay">
                        <span class="payment-icon"><i class="bi bi-credit-card-2-front"></i></span>
                        <span class="payment-label">6219861921574926</span>
                      </label>
                    </div>
                  </div>

                  <div class="payment-details" id="credit-card-details">
                    <p class="payment-info">جعفر قبادی</p>
                  </div>

                  <div class="payment-details d-none" id="paypal-details">
                    <p class="payment-info">جعفر قبادی</p>
                  </div>

                  <div class="payment-details d-none" id="apple-pay-details">
                    <p class="payment-info">جعفر قبادی</p>
                  </div>
                </div>
              </div>
              <form method="post" enctype="multipart/form-data">
                {% csrf_token %}

                <!-- Shipping Address Selection -->
                <div class="checkout-section" id="shipping-address">
                  <div class="section-header">
                    <div class="section-number">2</div>
                    <h3>انتخاب آدرس ارسال</h3>
                  </div>
                  <div class="section-content">
                    {% if form.shipping_address.errors %}
                      <div class="alert alert-danger">{{ form.shipping_address.errors }}</div>
                    {% endif %}

                    <div class="address-selection">
                      {% for radio in form.shipping_address %}
                        <div class="address-option">
                          {{ radio.tag }}
                          <label for="{{ radio.id_for_label }}" class="address-card">{{ radio.choice_label }}</label>
                        </div>
                      {% endfor %}
                    </div>

                    {% if form.shipping_address.errors %}
                      <div class="text-danger mt-2">{{ form.shipping_address.errors }}</div>
                    {% endif %}

                    <div class="mt-3">
                      <a href="{% url 'dashboard:addresses' %}" class="btn btn-outline-primary">
                        <i class="bi bi-plus-circle"></i>
                        مدیریت آدرس‌ها
                      </a>
                    </div>
                  </div>
                </div>

                <!-- Payment Method -->
                <div class="checkout-section" id="payment-method">
                  <div class="section-header">
                    <div class="section-number">3</div>
                    <h3>اطلاعات پرداخت</h3>
                  </div>
                  <div class="section-content">
                    <div class="form-group">
                      <label for="{{ form.payment_receipt.id_for_label }}">
                        {{ form.payment_receipt.label }}
                        <span class="text-danger">*</span>
                      </label>
                      {{ form.payment_receipt }}
                      {% if form.payment_receipt.help_text %}
                        <small class="form-text text-muted">{{ form.payment_receipt.help_text }}</small>
                      {% endif %}
                      {% if form.payment_receipt.errors %}
                        <div class="text-danger">{{ form.payment_receipt.errors }}</div>
                      {% endif %}
                      <div class="mt-2">
                        <img id="receipt-preview" src="#" alt="پیش‌نمایش رسید" style="max-width: 300px; display: none;" class="img-thumbnail" />
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Order Review -->
                <div class="checkout-section" id="order-review">
                  <div class="section-header">
                    <div class="section-number">4</div>
                    <h3>بررسی و ثبت سفارش</h3>
                  </div>
                  <div class="section-content">
                    <div class="form-check terms-check">
                      {{ form.terms_accepted }}
                      <label class="form-check-label" for="{{ form.terms_accepted.id_for_label }}">
                        {{ form.terms_accepted.label }}
                        <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">شرایط و ضوابط</a>
                        و
                        <a href="#" data-bs-toggle="modal" data-bs-target="#privacyModal">سیاست حفظ حریم خصوصی</a>
                      </label>
                      {% if form.terms_accepted.errors %}
                        <div class="text-danger">{{ form.terms_accepted.errors }}</div>
                      {% endif %}
                    </div>

                    <div class="place-order-container">
                      <button type="submit" class="btn btn-primary place-order-btn"><span class="btn-text">ثبت سفارش</span></button>
                    </div>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <div class="col-lg-5">
            <!-- Order Summary -->
            <div class="order-summary" data-aos="fade-left" data-aos-delay="200">
              <div class="order-summary-header">
                <h3>خلاصه سفارش</h3>
                <span class="item-count">{{ cart.get_total_items }} محصول</span>
              </div>

              <div class="order-summary-content">
                <div class="order-items">
                  {% for item in cart.items.all %}
                    <div class="order-item">
                      <div class="order-item-image">
                        {% if item.product.image %}
                          <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="img-fluid" />
                        {% else %}
                          <img src="{% static 'img/no-image.png' %}" alt="{{ item.product.name }}" class="img-fluid" />
                        {% endif %}
                      </div>
                      <div class="order-item-details">
                        <h4>{{ item.product.name }}</h4>
                        <div class="order-item-price">
                          <span class="quantity">{{ item.quantity }} ×</span>
                          <span class="price formatted-price">{{ item.product.get_price }} تومان</span>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                </div>

                <div class="order-totals">
                  <div class="order-subtotal d-flex justify-content-between">
                    <span>جمع جزء</span>
                    <span class="formatted-price">{{ subtotal }} تومان</span>
                  </div>
                  <div class="order-shipping d-flex justify-content-between">
                    <span>هزینه ارسال</span>
                    <span class="formatted-price">{{ shipping_cost }} تومان</span>
                  </div>
                  <div class="order-total d-flex justify-content-between">
                    <span>جمع کل</span>
                    <span class="formatted-price">{{ total }} تومان</span>
                  </div>
                </div>

                <div class="secure-checkout">
                  <div class="secure-checkout-header">
                    <i class="bi bi-shield-lock"></i>
                    <span>پرداخت امن</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Terms and Privacy Modals -->
        <div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="termsModalLabel">شرایط و قوانین</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <h6>قوانین عمومی</h6>
                <p>1. کلیه خریدها با توجه به موجودی کالا انجام می‌شود.</p>
                <p>2. قیمت‌ها به تومان بوده و شامل مالیات نمی‌باشد.</p>
                <p>3. ارسال کالا در شهر تهران 24 تا 48 ساعت و سایر شهرها 3 تا 7 روز کاری زمان می‌برد.</p>
                <p>4. امکان بازگرداندن کالا تا 7 روز پس از تحویل وجود دارد.</p>

                <h6 class="mt-4">روش پرداخت</h6>
                <p>پرداخت از طریق واریز به حساب بانکی فروشگاه انجام می‌شود.</p>

                <h6 class="mt-4">روش ارسال</h6>
                <p>ارسال از طریق پست پیشتاز یا تیپاکس انجام می‌شود.</p>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">متوجه شدم</button>
              </div>
            </div>
          </div>
        </div>

        <div class="modal fade" id="privacyModal" tabindex="-1" aria-labelledby="privacyModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="privacyModalLabel">حریم خصوصی</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <h6>حفاظت از اطلاعات</h6>
                <p>فروشگاه گوریلا متعهد به حفظ حریم خصوصی و امنیت اطلاعات کاربران می‌باشد.</p>

                <h6 class="mt-4">اطلاعات جمع‌آوری شده</h6>
                <p>• اطلاعات شخصی (نام، شماره تماس، آدرس)</p>
                <p>• اطلاعات پرداخت (شماره کارت در سیستم بانکی ذخیره نمی‌شود)</p>
                <p>• اطلاعات سفارشات</p>

                <h6 class="mt-4">استفاده از اطلاعات</h6>
                <p>اطلاعات شما تنها برای ارسال سفارش و ارتباط با شما استفاده می‌شود.</p>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">متوجه شدم</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- /Checkout Section -->
  </main>

  <script>
    // Preview payment receipt image
    document.getElementById('{{ form.payment_receipt.id_for_label }}').addEventListener('change', function (e) {
      const file = e.target.files[0]
      if (file) {
        const reader = new FileReader()
        reader.onload = function (e) {
          const preview = document.getElementById('receipt-preview')
          preview.src = e.target.result
          preview.style.display = 'block'
        }
        reader.readAsDataURL(file)
      }
    })
    
    // Copy bank card number to clipboard
    function copyToClipboard(text) {
      const textarea = document.createElement('textarea')
      textarea.value = text.replace(/-/g, '')
      document.body.appendChild(textarea)
      textarea.select()
      document.execCommand('copy')
      document.body.removeChild(textarea)
    
      // Show feedback
      alert('شماره کارت کپی شد')
    }
  </script>
{% endblock %}
