{% extends 'base.html' %}
{% load static %}

{% block title %}
  تسویه حساب فروشگاه اینترنتی مکمل گوریلا
{% endblock %}

{% block content %}
  <main class="main">
    <!-- Page Title -->
    <div class="page-title light-background">
      <div class="container d-lg-flex justify-content-between align-items-center">
        <h1 class="mb-2 mb-lg-0">تسویه حساب</h1>
        <nav class="breadcrumbs">
          <ol>
            <li>
            </li>
            <li class="current">تسویه حساب</li>
          </ol>
        </nav>
      </div>
    </div>
    <!-- End Page Title -->

    <!-- Checkout Section -->
    <section id="checkout" class="checkout section">
      <div class="container" data-aos="fade-up" data-aos-delay="100">
        <div class="row">
          <div class="col-lg-7">
            <!-- Checkout Form -->
            <div class="checkout-container" data-aos="fade-up">


                          <form method="post" enctype="multipart/form-data">
              {% csrf_token %}

              <!-- نمایش خطاها -->
              {% if form.errors %}
                <div class="alert alert-danger">
                  <ul>
                    {% for field in form %}
                      {% for error in field.errors %}
                        <li>{{ field.label }}: {{ error }}</li>
                      {% endfor %}
                    {% endfor %}
                    {% for error in form.non_field_errors %}
                      <li>{{ error }}</li>
                    {% endfor %}
                  </ul>
                </div>
              {% endif %}

              <!-- بخش 1: انتخاب آدرس -->
              <div class="address-selection">
                      {% for address in form.fields.shipping_address.queryset %}
                        <div class="address-option">
                          <input 
                            type="radio" 
                            name="shipping_address" 
                            id="address_{{ address.id }}" 
                            value="{{ address.id }}"
                            {% if address.is_default %}checked{% endif %}
                          />
                          <label for="address_{{ address.id }}" class="address-card">
                            <div class="address-header">
                              <span class="address-label">
                                <i class="bi bi-geo-alt"></i>
                                {{ address.label }}
                              </span>
                              {% if address.is_default %}
                                <span class="badge bg-primary">پیش‌فرض</span>
                              {% endif %}
                            </div>
                            <div class="address-details">
                              <p class="address-name">
                                <strong>{{ address.full_name }}</strong>
                              </p>
                              <p class="address-phone">
                                <i class="bi bi-telephone"></i>
                                {{ address.phone }}
                              </p>
                              <p class="address-text">
                                {{ address.get_short_address }}
                              </p>
                              <p class="address-postal">
                                کد پستی: {{ address.postal_code }}
                              </p>
                            </div>
                          </label>
                        </div>
                      {% endfor %}
                    </div>

              <!-- بخش 2: اطلاعات پرداخت -->
              <div class="checkout-section" id="payment-method">
                  <div class="section-header">
                    <div class="section-number">2</div>
                    <h3>اطلاعات پرداخت</h3>
                  </div>
                  <div class="section-content">
                    <div class="bank-info">
                      <div class="alert alert-info">
                        <h5>
                          <i class="bi bi-info-circle"></i>
                          راهنمای پرداخت
                        </h5>
                        <p>لطفاً مبلغ <strong>{{ total|floatformat:2 }} تومان</strong> را به شماره کارت زیر واریز نمایید:</p>
                      </div>
                      
                      <div class="card mb-3">
                        <div class="card-body">
                          <div class="bank-card-display">
                            <div class="bank-card-number">
                              <label>شماره کارت:</label>
                              <div class="card-number-display">
                                {{ bank_card_number }}
                                <button type="button" class="btn btn-sm btn-outline-secondary copy-btn" onclick="copyToClipboard('{{ bank_card_number }}')">
                                  <i class="bi bi-clipboard"></i>
                                  کپی
                                </button>
                              </div>
                            </div>
                            <div class="bank-card-holder">
                              <label>به نام:</label>
                              <span>{{ bank_account_holder }}</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="form-group">
                      <label for="{{ form.payment_receipt.id_for_label }}">
                        {{ form.payment_receipt.label }}
                        <span class="text-danger">*</span>
                      </label>
                      {{ form.payment_receipt }}
                      {% if form.payment_receipt.help_text %}
                        <small class="form-text text-muted">{{ form.payment_receipt.help_text }}</small>
                      {% endif %}
                      {% if form.payment_receipt.errors %}
                        <div class="text-danger">{{ form.payment_receipt.errors }}</div>
                      {% endif %}
                      <div class="mt-2">
                        <img id="receipt-preview" src="#" alt="پیش‌نمایش رسید" style="max-width: 300px; display: none;" class="img-thumbnail"/>
                      </div>
                    </div>

                    <div class="form-group mt-3">
                      <label for="{{ form.notes.id_for_label }}">
                        {{ form.notes.label }}
                      </label>
                      {{ form.notes }}
                      {% if form.notes.errors %}
                        <div class="text-danger">{{ form.notes.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>

              <!-- بخش 3: قبول شرایط و ثبت -->
              <div class="mb-4">
                <h5>3. قبول شرایط و ثبت سفارش</h5>
                <hr />

                    <div class="form-check terms-check">
                      {{ form.terms_accepted }}
                      <label class="form-check-label" for="{{ form.terms_accepted.id_for_label }}">
                        {{ form.terms_accepted.label }}
                        <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">شرایط و قوانین</a>
                        و
                        <a href="#" data-bs-toggle="modal" data-bs-target="#privacyModal">حریم خصوصی</a>
                      </label>
                      {% if form.terms_accepted.errors %}
                        <div class="text-danger">{{ form.terms_accepted.errors }}</div>
                      {% endif %}
                    </div>

                <button type="submit" class="btn btn-primary btn-lg w-100">ثبت سفارش - {{ total|floatformat:2 }} تومان</button>
              </div>
            </form>
            </div>
          </div>

          <div class="col-lg-5">
            <!-- Order Summary -->
            <div class="order-summary" data-aos="fade-left" data-aos-delay="200">
              <div class="order-summary-header">
                <h3>خلاصه سفارش</h3>
                <span class="item-count">{{ cart.get_total_items }} محصول</span>
              </div>

              <div class="order-summary-content">
                <div class="order-items">
                  {% for item in cart.items.all %}
                    <div class="order-item">
                      <div class="order-item-image">
                        {% if item.product.image %}
                          <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="img-fluid" />
                        {% else %}
                          <img src="{% static 'img/no-image.png' %}" alt="{{ item.product.name }}" class="img-fluid" />
                        {% endif %}
                      </div>
                      <div class="order-item-details">
                        <h4>{{ item.product.name }}</h4>
                        <div class="order-item-price">
                          <span class="quantity">{{ item.quantity }} ×</span>
                          <span class="price">{{ item.product.get_price|floatformat:2 }} تومان</span>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                </div>

                <div class="order-totals">
                  <div class="order-subtotal d-flex justify-content-between">
                    <span>جمع جزء</span>
                    <span>{{ subtotal|floatformat:2 }} تومان</span>
                  </div>
                  <div class="order-shipping d-flex justify-content-between">
                    <span>هزینه ارسال</span>
                    <span>{{ shipping_cost|floatformat:2 }} تومان</span>
                  </div>
                  <div class="order-tax d-flex justify-content-between">
                    <span>مالیات</span>
                    <span>{{ tax|floatformat:2 }} تومان</span>
                  </div>
                  <div class="order-total d-flex justify-content-between">
                    <span>جمع کل</span>
                    <span>{{ total|floatformat:2 }} تومان</span>
                  </div>
                </div>

                <div class="secure-checkout">
                  <div class="secure-checkout-header">
                    <i class="bi bi-shield-lock"></i>
                    <span>پرداخت امن</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Terms and Privacy Modals -->
        <div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="termsModalLabel">شرایط و قوانین</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <p>متن شرایط و قوانین فروشگاه در اینجا قرار می‌گیرد...</p>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">متوجه شدم</button>
              </div>
            </div>
          </div>
        </div>

        <div class="modal fade" id="privacyModal" tabindex="-1" aria-labelledby="privacyModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="privacyModalLabel">حریم خصوصی</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <p>متن حریم خصوصی فروشگاه در اینجا قرار می‌گیرد...</p>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">متوجه شدم</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- /Checkout Section -->
  </main>

  <script>
    // Preview payment receipt image
    document.getElementById('{{ form.payment_receipt.id_for_label }}').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const preview = document.getElementById('receipt-preview');
          preview.src = e.target.result;
          preview.style.display = 'block';
        }
        reader.readAsDataURL(file);
      }
    });

    // Copy bank card number to clipboard
    function copyToClipboard(text) {
      const textarea = document.createElement('textarea');
      textarea.value = text.replace(/-/g, '');
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);
      
      // Show feedback
      alert('شماره کارت کپی شد');
    }
  </script>
{% endblock %}